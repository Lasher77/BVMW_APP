generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum EventStatus {
  Planned
  Confirmed
  Completed
  Cancelled
}

enum MemberType {
  contact
  lead
}

enum RegistrationStatus {
  registered
  pending
  rejected
  cancelled
  attended
}

enum WebhookSource {
  salesforce_campaign
  salesforce_attendee
}

enum WebhookStatus {
  accepted
  failed
  processed
}

model Event {
  id              String               @id @default(uuid())
  sfCampaignId    String               @unique @map("sf_campaign_id")
  title           String
  subtitle        String?              @db.Text
  description     String?              @db.Text
  status          EventStatus
  isPublic        Boolean              @map("is_public")
  isOnline        Boolean              @map("is_online")
  start           DateTime             @db.Timestamptz(6)
  end             DateTime             @db.Timestamptz(6)
  venueName       String?              @map("venue_name")
  street          String?
  postalCode      String?              @map("postal_code")
  city            String?
  state           String?
  country         String?
  region          String?
  lat             Float?               @db.DoublePrecision
  lon             Float?               @db.DoublePrecision
  dooEventId      String?              @map("doo_event_id")
  registrationUrl String?              @map("registration_url")
  headerImageUrl  String?              @map("header_image_url")
  tags            String[]             @db.Text
  registrations   Registration[]
  createdAt       DateTime             @default(now()) @map("created_at")
  updatedAt       DateTime             @updatedAt @map("updated_at")
}

model Member {
  id          String          @id
  type        MemberType
  name        String?         @db.Text
  emailHash   String?         @map("email_hash")
  company     String?         @db.Text
  registrations Registration[]
  createdAt   DateTime        @default(now()) @map("created_at")
  updatedAt   DateTime        @updatedAt @map("updated_at")
}

model Registration {
  id           String             @id @default(uuid())
  event        Event              @relation(fields: [eventId], references: [id])
  eventId      String             @map("event_id")
  member       Member             @relation(fields: [memberId], references: [id])
  memberId     String             @map("member_id")
  status       RegistrationStatus
  checkInAt    DateTime?          @map("check_in_at") @db.Timestamptz(6)
  dooEventId   String?            @map("doo_event_id")
  dooAttendeeId String?           @map("doo_attendee_id")
  dooBookingId String?            @map("doo_booking_id")
  sources      Json?              @map("sources")
  createdAt    DateTime           @default(now()) @map("created_at")
  updatedAt    DateTime           @updatedAt @map("updated_at")

  @@unique([eventId, memberId])
}

model WebhookEvent {
  id              String         @id @default(uuid())
  source          WebhookSource
  idempotencyKey  String         @unique @map("idempotency_key")
  payload         Json
  processedAt     DateTime?      @map("processed_at") @db.Timestamptz(6)
  status          WebhookStatus
  error           String?        @db.Text
  createdAt       DateTime       @default(now()) @map("created_at")
  updatedAt       DateTime       @updatedAt @map("updated_at")
}
